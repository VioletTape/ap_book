# 6. Инвентаризация и учет

Большая часть коммерческих компьютерных систем предназначена для отслеживания движения денег предприятия, т.е. регистрации как они зарабатываются и тратятся. Фундаментальная идея бухгалтерского учета и отслеживания запасов заключается в существовании различных корзин с деньгами и товарами. Необходимо фиксировать движение денег и товаров между этими корзинами.

Модели инвентаризации и учета, описанные в этой главе, родились из этой фундаментальной идеи. Они представляют собой основной набор концепций, которые могут использоваться в качестве основы для финансового учета, инвентаризации или управления ресурсами. Паттерны не описывают эти процессы напрямую, они скорее описывают базовые идеи, на основе которых можно строить процессы. В главе 7 описан простой пример, в котором эти идеи используются для выставления счетов за телефонные звонки.

В этой главе я использую простой личный финансовый пример, чтобы объяснить основные идеи бухгалтерского учета и инвентаризации. Используемые далее термины похожи на традиционные из финансовой сферы, но я использую их в понятийном смысле. В поисках более абстрактной модели я обнаружил, что мне нужны новые термины и понятия. Особенностью моделей из этой главы является описание как правила обработки встраиваются в систему счетов. Такой подход позволяет счетам обновляться и управлять собой. Таким образом, традиционно пассивная система учета превращается в активную систему, которую можно настраивать, подключая счета соответствующим образом.

Первый шаблон — это _счет_ ([6.1](#6-1-account)). На счете хранятся ценные вещи — товары или деньги, — которые можно добавлять или удалять только с помощью записей (проводок). Они обеспечивают историю всех изменений на счете. Когда мы используем счет для записи истории изменений ценных вещей, важно следить за тем, чтобы предметы не потерялись. _Транзакции_ ([6.2](#6-2-transactions)) добавляют еще одну степень проверяемости, связывая проводки вместе. В транзакции предметы, снятые с одного счета, должны быть помещены на другой; предметы не могут быть созданы или уничтожены.

Существует два вида транзакций: Двухуровневая операция перемещает сумму с одного счета на другой. Многоногая транзакция может иметь записи на нескольких счетах, пока транзакция в целом сбалансирована по приходу\расходу.

Счета можно объединять в группы с помощью _суммарного счета_ ([6.3](#6-3-summary-account)), который применяет большинство функций отчетности к группам счетов. Иногда нам нужно сделать записи по счетам, которые не предназначены для поддержания баланса; с этой задачей справляется _мемо счет_ (memo account - временный счет по своей сути) ([6.4](#6-4-memo-account)).

Счет может содержать фиксированные правила, определяющие порядок перевода сумм между счетами. _Правила проводок_ ([6.5](#6-5-posting-rules)) позволяют нам создавать активные сети счетов, которые обновляют друг друга и отражают бизнес-правила. Для этого экземпляры правила проводки должны иметь свои собственные исполняемые методы, и это требование вводит важную концепцию моделирования _метода индивидуального экземпляра_ ([6.6](#6-6-individual-instance-method)). Методы индивидуальных экземпляров могут быть реализованы с помощью некоторой комбинации одного подтипа, шаблона стратегии, внутреннего оператора case, интерпретатора и параметризованного метода.

Шаблон _выполнение правил проводки_ ([6.7](#6-7-posting-rule-execution)) описывает способы запуска правил проводки: 
- во время создания транзакции; 
- путем запроса учетной записи на обработку ее правил; 
- путем запроса на срабатывание правила проводки; 
- или путем запроса учетной записи на обновление, что приводит к срабатыванию ее предшественников в порядке обратной цепочки.

Чтобы использовать правила проводок со многими счетами, нам нужен способ определения _правил проводок для многих счетов_ ([6.8](#6-8-posting-rules-for-many-accounts)). Один из способов — использовать _уровень знаний_, в этом случае правила проводок определяются для типов счетов. Другой способ — связать правила проводок с суммарными счетами.

В бухгалтерской системе различным объектам нужны подмножества записей по счету и их остатков, и для того, и для другого требуется шаблон _выбора записей_ ([6.9](#6-9-choosing-entries)). Этот шаблон полезен, когда мы хотим выбрать объекты из многозначного отображения. Доступные опции — вернуть весь набор и позволить клиенту сделать выборку, добавить дополнительные операции к счету или использовать фильтр счета.

Мы можем разделить большие сети правил проводок на группы с помощью шаблона _бухгалтерской практики_ ([6.10](#6-10-accounting-practice)). В длинных расчетах нам часто приходится возвращаться назад, чтобы понять, почему те или иные операции привели к текущей ситуации; тогда нам нужно использовать _схему источников записи_ ([6.11](#6-11-sources-of-an-entry)).

В _балансовых отчетах и отчетах о прибыли_ ([6.12](#6-12-balance-sheet-and-income-statement)) различают счета для инвентаризации и для расходных материалах. Люди могут иметь схожие представления о счетах; например, мое представление о банковском счете, вероятно, схоже с представлением моего банка. Один из них является _корреспондентским счетом_ ([6.13](#6-13-corresponding-account)) другого.

Полученные шаблоны достаточно абстрактны; для применения их в повседневной практике в конкретных случаях требуется _специализированная модель счета_ ([6.14](#6-14-specialized-account-model)). Такие счета разрабатываются путем подтипизации общих шаблонов учета.

Последний шаблон в этой главе описывает _проводки по нескольким счетам_ ([6.15](#6-15-booking-entries-to-multiple-accounts)). Этот шаблон полезен, когда существует более одного способа отразить в отчете следы записей. Два альтернативных способа — это использование проводок или использование производных счетов. Мы можем использовать производные счета вместо шаблонов учета, если нам нужны отчеты поведения счетов, но не возможности балансировки и аудита.

Эти модели — результат идей, возникших в ходе нескольких проектов. Они возникли в ходе работы над системой обслуживания клиентов для американской коммунальной компании и получили дальнейшее развитие при изучении структуры бухгалтерского учета для международной телекоммуникационной компании. Кроме того, в моделях использован опыт недавней разработки системы расчета заработной платы для крупной американской производственной компании.

<deflist type="narrow">
    <def title="Ключевые понятия">
         Счет, транзакция, проводка, правило проводки
    </def>
</deflist>

## 6.1 Account

Во многих сферах деятельности важно вести учет не только текущей стоимости чего-либо, но и деталей каждого изменения, влияющего на эту стоимость. Банковский счет должен регистрировать каждое снятие и внесение средств; инвентарный учет должен фиксировать каждое добавление или удаление предметов.

Счет похож на атрибут количества, с добавлением записи для каждого изменения его значения, как показано на рисунке 6.1. Баланс, который представляет собой текущее значение счета, является чистым результатом всех записей, связанных со счетом. Это не означает, что баланс нужно пересчитывать каждый раз, когда он запрашивается. Производные значения можно кэшировать, хотя кэш будет невидим для пользователя счета. Используя записи, клиент может также определить изменения за определенный период времени и общую сумму пополнений или снятий (см. раздел 6.9). Знак на сумме указывает на то, является ли данная запись депозитом или снятием средств. Выписка — это список всех записей, которые были сделаны по счету за определенный период времени.

===IMAGE====

_Проводки фиксируют каждое изменение в счете._

**Рисунок 6.1. Счет и запись.**



**Пример:** Я снимаю 100 долларов со своего расчетного счета. Это представлено в виде записи с суммой -$100, прикрепленной к моему расчетному счету.

**Пример:** Я покупаю в магазине 4 пачки стандартной писчей бумаги. Магазин отражает это как запись на своем счете стандартной писчей бумаги с суммой -4 пачки.

**Пример:** В январе я использовал 350 кВт-ч электроэнергии. Это отражается в виде записи с суммой 350 кВт-ч на моем счете использования электроэнергии в быту.

<tip>
    <p>
        <b>Принцип моделирования</b>
    </p>
    <p>Чтобы зафиксировать историю изменений стоимости, используйте счет для этой стоимости.</p>
</tip>

Один из способов, которым реализация может вычислить баланс, — по коллекции записей сформировать коллекцию количеств. Для этого в Smalltalk есть специальная операция collect. Опасность заключается в том, что операция collect собирает объекты в коллекцию того же типа, что и исходная. Таким образом, если выполнить collect над набором записей, то получится набор количеств. Наборы не допускают дублирования, поэтому если у нас есть две записи с одинаковым количеством, то учитывается только количество первой записи, что приведёт к неверному балансу. Для формирования коллекций фундаментальных значений часто лучше использовать пакет, который допускает дубликаты. В C++ эта проблема встречается реже, поскольку операции collect менее распространены и более сложны в использовании; вместо них пользователи C++ используют внешний итератор (шаблон проектирования из GoF), который не имеет такой проблемы. Однако в качестве проверки тестовые примеры всегда должны включать записи с равными суммами (а также записи, у которых все атрибуты равны).

На рисунке 6.1 показаны две временные точки для записи: одна указывает на момент списания, а другая — на момент занесения записи на счет. Это особенно важно, когда происходит ретроактивное списание. Цена списания может измениться между датой списания и датой резервирования, поэтому необходимы обе даты. Нам необходимо знать как историю событий, так и наши знания об этой истории (см. раздел 15.3.1). Временные точки также включают как время суток, так и дату; многие приложения довольствуются только датой.

Пример: Я обедал в кафе Jae's 1 апреля. Компания, обслуживающая кредитную карту, получает уведомление об оплате 4 апреля. Запись имеет дату списания 1 апреля и дату бронирования 4 апреля.


## 6.2 Transactions

## 6.3 Summary Account

## 6.4 Memo Account

## 6.5 Posting Rules

## 6.6 Individual Instance Method

## 6.7 Posting Rule Execution

## 6.8 Posting Rules for Many Accounts

## 6.9 Choosing Entries

## 6.10 Accounting Practice

## 6.11 Sources of an Entry

## 6.12 Balance Sheet and Income Statement

## 6.13 Corresponding Account

## 6.14 Specialized Account Model

## 6.15 Booking Entries to Multiple Accounts

Further Reading

## References